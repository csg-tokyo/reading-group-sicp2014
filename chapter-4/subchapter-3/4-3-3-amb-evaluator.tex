\setcounter{subsubsection}{2}
\subsubsection{Amb評価機の実装}
普通のSchemeの式はの評価では, 値が返ってくる, 処理が終わらない, エラーが出るという
３つのケースがある. 非決定性演算を追加すると, 解が見つからずバックトラックするケース
が増えるので, 評価が複雑になる.
Amb評価機を作るために, プロシージャの実行を変える必要がある.

\paragraph{プロシージャと継続の実装}
以前作った評価機では, プロシージャを評価する時に環境を表す引数を受け取っていた.
Amb評価機の場合は, 環境引数以外にも２つの引数を渡す必要がある. その２つの引数は
継続プロシージャで, 成功の時に実行するプロシージャと失敗する時に実行するプロシージャである.

実行順番でいうと, あり得る任意の値が選択されて, その値と失敗のための時の新しい
失敗継続が成功継続に渡されていく. 失敗があった場合(あり得る値が選択できない場合)は,
失敗継続が呼び出されることによって, バックトラックを行う.

失敗継続については, 構築される場合はいくつかある.

\begin{itemize}
\item \lstinline{amb}式がある場合. \lstinline{amb}式がある場合, バックトラックできるように
  \lstinline{amb}式が構築される.
\item トップレベル. バックトラックができなくなった時, エラーを表示する.
\item 代入. バックトラックする時に代入を取り消すために.
\end{itemize}

また, 失敗継続が以下の２つのケースで呼び出される.

\begin{itemize}
\item \lstinline{(amb)}が実行される時.
\item ユーザは\lstinline{try-again}を実行した時.
\end{itemize}

さらに, 次の場合は失敗継続が連続で呼び出される.

\begin{itemize}
\item バックトラックする前に失敗継続でサイド・エフェクトの処理（例えば代入）を
  クリーンアップする場合は, クリーンアップが終わったあとに元々渡された失敗継続を
  呼び出しバックトラックの続きを行う.
\item 選択肢がなくなった時に, \lstinline{amb}に元々渡された失敗継続を呼び出すことによって
  失敗の前の選択点に戻る.
\end{itemize}
